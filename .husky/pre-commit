#!/bin/bash

# Get the list of changed Apex (.cls) or LWC files
changed_files=$(git diff --cached --name-only | grep -E '\.cls$|\.lwc$')

# Check if there are any relevant changes
if [ -z "$changed_files" ]; then
  echo "No relevant changes to scan."
  exit 0
fi

# Ensure that a valid directory exists for the scanner report
output_dir="./scanner-reports"
mkdir -p "$output_dir"

# Loop through each changed file to get the changed lines
for file in $changed_files; do
  echo "Checking file: $file"

  # Get the changed lines for each file (in unified diff format)
  changed_lines=$(git diff --cached -U0 $file | grep -E '^\+[^+]' | sed 's/^\+//')

  # If there are changed lines, run the scanner for the entire file
  if [ ! -z "$changed_lines" ]; then
    echo "Changed lines for $file:"
    echo "$changed_lines"
    
    # Define the output file path
    output_file="$output_dir/$(basename $file).json"

    # Run the SFDX scanner for the entire file and save the report in the output directory
    sf scanner:run --target "$file" --format "json" --outfile "$output_file"

    # Check if the JSON report exists
    if [ ! -f "$output_file" ]; then
      echo "Scanner report not found for $file. Please check the scanner command."
      exit 1
    fi

    # Parse the JSON report and check for violations (adjust jq command to match your JSON structure)
    severity_fail_count=$(jq '[.result.summary.files[].violations[] | select(.severity == 3)] | length' "$output_file")

    # Output the fail count for debugging
    echo "Severity Fail Count for $file: $severity_fail_count"

    # Block commit if there are severity 3 issues
    if [ "$severity_fail_count" -gt 0 ]; then
      echo "Blocking your commit due to vulnerabilities found with severity 3 in $file."
      exit 1
    fi
  else
    echo "No significant changes in $file."
  fi
done

echo "No vulnerabilities found. Proceeding with commit."
exit 0