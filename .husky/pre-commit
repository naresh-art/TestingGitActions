#!/bin/bash

# Get the current branch name dynamically
current_branch=$(git branch --show-current)

# Get the list of changed Apex (.cls) or LWC files staged for commit
changed_files=$(git diff --cached --name-only | grep -E '\.cls$|\.lwc$')

# Check if there are any relevant changes
if [ -z "$changed_files" ]; then
  echo "No relevant changes to scan."
  exit 0
fi

# Run the SFDX scanner on the changed files
sf scanner:run --target "$changed_files" --format "json" --outfile "precommit-scanner-report.json"

# Check if the JSON report exists
if [ ! -f "precommit-scanner-report.json" ]; then
  echo "Scanner report not found. Please check the scanner command."
  exit 1
fi

# Manually parse the JSON and check for severity 3 issues within the violations array
severity_fail_count=$(grep -oP '"severity":\s*3' precommit-scanner-report.json | wc -l)

# Output the fail count for debugging
echo "Severity Fail Count:::::: $severity_fail_count"

# Block commit if there are severity 3 issues
if [ "$severity_fail_count" -gt 0 ]; then
  echo "Blocking your commit due to vulnerabilities found with severity 3."
  # Optionally display the report for the user
  cat precommit-scanner-report.json
  exit 1
else
  # No violations found, proceed with commit
  echo "No vulnerabilities found. Proceeding with commit."
  
  # Commit the changes (this happens automatically if no errors are found)
  
  # Automatically push the changes to the current branch
  echo "Pushing the changes to the current branch: $current_branch"
  git push origin "$current_branch"
  
  echo "Changes pushed successfully to branch: $current_branch"
  exit 0
fi