#!/bin/bash

# Get the list of changed Apex (.cls) or LWC files
changed_files=$(git diff --cached --name-only | grep -E '\.cls$|\.lwc$')

# Check if there are any relevant changes
if [ -z "$changed_files" ]; then
  echo "No relevant changes to scan in the files."
  exit 0
fi

# Convert changed_files into an array
changed_files_array=($changed_files)

# Initialize a temp file to hold the diff data
diff_file="changed_lines.diff"

# Collect the diffs (changed lines) for each file
for file in "${changed_files_array[@]}"
do
  echo "Collecting changed lines for file: $file"
  # Get only the changed lines (-U0 for no context)
  git diff --cached -U0 "$file" >> "$diff_file"
done

# Check if the diff file contains any data
if [ ! -s "$diff_file" ]; then
  echo "No changed lines found."
  exit 0
fi

# Display the diff file for debugging purposes
echo "Changed lines:"
cat "$diff_file"

# Run the SFDX scanner on the original files (scanner needs full context to check for violations)
sf scanner:run --target "${changed_files_array[@]}" --format "json" --outfile "precommit-scanner-report.json"

# Check if the JSON report exists
if [ ! -f "precommit-scanner-report.json" ]; then
  echo "Scanner report not found. Please check the scanner command."
  exit 1
fi

# Extract line numbers from the diff to match with scanner report
echo "Extracting line numbers for changed lines..."
changed_line_numbers=$(grep -oP '@@\s-\d+,\d+\s+\+\K\d+' "$diff_file")

# Parse the violations from the scanner report that match changed line numbers
echo "Checking violations in changed lines..."
violations_in_changed_lines=0

# Loop through the line numbers and check if there are any matching violations
for line_number in $changed_line_numbers; do
  # Grep the JSON report for violations in this line number
  if grep -q "\"beginLine\": $line_number" precommit-scanner-report.json; then
    # If a violation exists in this line number, increment the count
    violations_in_changed_lines=$((violations_in_changed_lines + 1))
  fi
done

# Output the violation count for debugging
echo "Number of violations found in changed lines: $violations_in_changed_lines"

# Block commit if there are violations in the changed lines
if [ "$violations_in_changed_lines" -gt 0 ]; then
  echo "Blocking your commit due to violations found in changed lines."
  exit 1
else
  echo "No violations found in changed lines. Proceeding with commit."
  exit 0
fi
