#!/bin/bash

# Get the list of changed Apex (.cls) or LWC files
changed_files=$(git diff --cached --name-only | grep -E '\.cls$|\.lwc$')

# Check if there are any relevant changes
if [ -z "$changed_files" ]; then
  echo "No relevant changes to scan in the files."
  exit 0
fi

# Convert changed_files into an array
changed_files_array=($changed_files)

# Initialize a temp file to hold the full class with changed lines
temp_scan_file="temp_scan.cls"

# Start with an empty file
> "$temp_scan_file"

# Collect the diff (changed lines) for each file and reconstruct the class structure
for file in "${changed_files_array[@]}"
do
  echo "Processing file: $file"

  # Extract only the changed lines (lines starting with '+') and remove the '+' symbol
  changed_lines=$(git diff --cached -U0 "$file" | grep '^+' | sed 's/^+//')

  # Get the class declaration from the original file (looks for 'public class', 'with sharing', etc.)
  class_declaration=$(grep -E 'public|global.*class' "$file")
  
  # Find the line number where the class declaration starts and the class opens with '{'
  class_opening_line=$(grep -nE 'public|global.*class' "$file" | head -n 1 | cut -d ':' -f 1)
  
  # Find the line number of the closing brace for the class
  class_closing_line=$(grep -nE '^\s*\}\s*$' "$file" | tail -n 1 | cut -d ':' -f 1)

  # If a valid class structure is found, proceed with reconstruction
  if [ -n "$class_declaration" ] && [ -n "$class_opening_line" ] && [ -n "$class_closing_line" ]; then
    # Write the class declaration and the opening part of the class to the temp file
    head -n "$class_opening_line" "$file" > "$temp_scan_file"
    
    # Append the changed lines into the reconstructed class
    echo "$changed_lines" >> "$temp_scan_file"

    # Append the closing part of the class from the original file
    tail -n +"$class_closing_line" "$file" >> "$temp_scan_file"
  else
    echo "Unable to reconstruct the class structure for $file"
    exit 1
  fi
done

# Check if the temp_scan_file has data to scan
if [ ! -s "$temp_scan_file" ]; then
  echo "No valid class structure to scan."
  exit 0
fi

# Run the SFDX scanner on the reconstructed temp file
sf scanner:run --target "$temp_scan_file" --format "json" --outfile "precommit-scanner-report.json"

# Check if the JSON report exists
if [ ! -f "precommit-scanner-report.json" ]; then
  echo "Scanner report not found. Please check the scanner command."
  exit 1
fi

# Manually parse the JSON and check for severity 3 issues within violations array
severity_fail_count=$(grep -oP '"severity":\s*(3)' precommit-scanner-report.json | wc -l)

# Output the fail count for debugging
echo "Severity Fail Count::::::"
echo "$severity_fail_count"

# Block commit if there are severity 3 issues
if [ "$severity_fail_count" -gt 0 ]; then
  echo "Blocking your commit due to vulnerabilities found with severity 3."
  exit 1
else
  echo "No vulnerabilities found. Proceeding with commit."
  exit 0
fi
