#!/bin/bash

# Get the list of changed Apex (.cls) or LWC files
changed_files=$(git diff --cached --name-only | grep -E '\.cls$|\.lwc$')

# Check if there are any relevant changes
if [ -z "$changed_files" ]; then
  echo "No relevant changes to scan in the files."
  exit 0
fi

# Convert changed_files into an array
changed_files_array=($changed_files)

# Initialize a temp file to hold the diff data
diff_file="changed_lines.diff"

# Collect the diffs (changed lines) for each file
for file in "${changed_files_array[@]}"
do
  echo "Collecting changed lines for file: $file"
  # Get changed lines with context (-U3 to include 3 lines of context before and after)
  git diff --cached -U3 "$file" >> "$diff_file"
done

# Check if the diff file contains any data
if [ ! -s "$diff_file" ]; then
  echo "No changed lines found."
  exit 0
fi

# Display the diff file for debugging purposes
echo "Changed lines with context:"
cat "$diff_file"

# Run the SFDX scanner on the original files (scanner needs full context to check for violations)
sf scanner:run --target "${changed_files_array[@]}" --format "json" --outfile "precommit-scanner-report.json"

# Check if the JSON report exists
if [ ! -f "precommit-scanner-report.json" ]; then
  echo "Scanner report not found. Please check the scanner command."
  exit 1
fi

# Extract the list of violations and line numbers from the scanner report
echo "Extracting violations from scanner report..."
grep -oP '"beginLine":\s*\d+' precommit-scanner-report.json | grep -oP '\d+' > violation_lines.txt

# Extract line numbers from the diff context
echo "Extracting changed line numbers..."
grep -oP '@@\s-\d+,\d+\s+\+\K\d+' "$diff_file" > changed_lines.txt

# Check if any violation line numbers match the range of changed lines (or their surrounding context)
violations_in_changed_lines=0
while read -r changed_line; do
  # Check if there are any violations near this line (within a 3-line buffer)
  for violation_line in $(cat violation_lines.txt); do
    if ((violation_line >= changed_line - 3 && violation_line <= changed_line + 3)); then
      violations_in_changed_lines=$((violations_in_changed_lines + 1))
    fi
  done
done < changed_lines.txt

# Output the violation count for debugging
echo "Number of violations found in changed lines or surrounding context: $violations_in_changed_lines"

# Block commit if there are violations in the changed lines or context
if [ "$violations_in_changed_lines" -gt 0 ]; then
  echo "Blocking your commit due to violations found in changed lines or their surrounding context."
  exit 1
else
  echo "No violations found in changed lines or surrounding context. Proceeding with commit."
  exit 0
fi
