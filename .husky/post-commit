#!/bin/bash

# Get the current branch name
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Log the branch name to a file
echo "Pushing changes to branch: $current_branch" >> .husky/post-commit.log

# Create a temporary branch name with a timestamp
temp_branch="temp-branch-$(date +%Y%m%d%H%M%S)"

# Checkout the temporary branch
git checkout -b "$temp_branch"

# Push the changes to the temporary branch
git push origin "$temp_branch"

# Log the success or failure of the push operation
if [ $? -eq 0 ]; then
  echo "Successfully pushed changes to $temp_branch" >> .husky/post-commit.log

  # Fetch collaborators from GitHub API
  # Replace 'your-repo-owner' and 'your-repo-name' with actual repository details
  collaborators=$(curl -s -H "Authorization: token $GIT_TOKEN" \
    "https://api.github.com/repos/naresh-art/TestingGitActions/collaborators" \
    | jq -r '.[].login' | paste -sd "," -)
  
  # Log the list of collaborators
  echo "Collaborators: $collaborators" >> .husky/post-commit.log

  # Automatically create a pull request using GitHub CLI (gh) with dynamic reviewers
  gh pr create --base "$current_branch" --head "$temp_branch" --title "Auto PR from $temp_branch to $current_branch" --body "This is an automatically generated pull request." --reviewer "$collaborators"

  if [ $? -eq 0 ]; then
    echo "Successfully created pull request from $temp_branch to $current_branch and assigned reviewers: $collaborators" >> .husky/post-commit.log
  else
    echo "Failed to create pull request from $temp_branch to $current_branch" >> .husky/post-commit.log
  fi
else
  echo "Failed to push changes to $temp_branch" >> .husky/post-commit.log
fi

# Switch back to the original branch
git checkout "$current_branch"
