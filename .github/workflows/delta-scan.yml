name: Salesforce Code Scan on Pull Request

on:
  pull_request:
    branches:
      - '**'

jobs:
  run-code-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Install Scanner Plugin
        run: sf plugins install @salesforce/sfdx-scanner

      - name: Verify Salesforce CLI Installation
        run: sf --version

      - name: Verify Scanner Plugin Installation
        run: sf plugins --core

      - name: Get changed files
        id: get-changes
        run: |
          git fetch --unshallow || true
          if [ "$(git rev-list --count HEAD)" -gt "1" ]; then
            echo "Fetching changed files between HEAD~1 and HEAD"
            git diff --name-only HEAD~1 HEAD > changed_files.txt
          else
            echo "No previous commit to compare to." > changed_files.txt
          fi
          cat changed_files.txt

      - name: Run SFDX Scanner on All Changed Files
        id: run-scanner
        run: |
          # Create an empty CSV file
          echo "Rule Name,File,Line,Category,Severity,Message" > scanner-report.csv

          # Find all Apex (.cls) and LWC files and scan them
          files=$(cat changed_files.txt | grep -E '\.cls$|\.lwc$' || true)
          echo "Files to scan: $files"
          if [ -n "$files" ]; then
            for file in $files; do
              echo "Running scanner on $file"
              # Append results to the existing CSV file
              sf scanner:run --target "$file" --format csv --outfile temp-scanner-report.csv --category "Performance"
              # Append the scanned results into scanner-report.csv
              tail -n +2 temp-scanner-report.csv >> scanner-report.csv
            done
            # Clean up the temporary file
            rm temp-scanner-report.csv
          else
            echo "No relevant files changed."
          fi
        env:
          SF_LAZY_LOAD_MODULES: 'true'
          SF_AUTOUPDATE_DISABLE: 'true'
          SF_DISABLE_AUTOUPDATE: 'true'

      - name: Block PR merge if severity 3 violations are found
        run: |
          if [ -f scanner-report.csv ]; then
            severity_fail_count=$(awk -F',' '{gsub(/^ *| *$/, "", $2); if($2 == "\"3\"") count++} END {print count}' scanner-report.csv)
            echo "Severity 3 issues count: $severity_fail_count"
            if [ "$severity_fail_count" -gt 0 ]; then
              echo "Blocking your pull request due to severity 3 vulnerabilities found."
              exit 1
            else
              echo "No severity 3 vulnerabilities found. Proceeding."
            fi
          else
            echo "No scanner report found."
            exit 1
          fi

      - name: Upload Scanner Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: SFDX_Code_Scan_Report
          path: scanner-report.csv