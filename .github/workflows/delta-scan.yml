on:
  push:
    branches:
      - '**'

jobs:
  run-code-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Install Scanner Plugin
        run: sf plugins install @salesforce/sfdx-scanner

      - name: Verify Salesforce CLI Installation
        run: sf --version

      - name: Stash the changes temporarily
        run: |
          git stash # Stashing the changes temporarily

      - name: Run SFDX Scanner on Stashed Changes
        run: |
          git stash pop # Apply the stashed changes
          files=$(git diff --name-only | grep -E '\.cls$|\.lwc$' || true)
          echo "Files to scan: $files"
          if [ -n "$files" ]; then
            sf scanner:run --target "$files" --format csv --outfile scanner-report.csv || { echo "Scanner run failed"; exit 1; }
          else
            echo "No relevant files changed."
            touch scanner-report.csv
          fi
        env:
          SF_LAZY_LOAD_MODULES: 'true'
          SF_AUTOUPDATE_DISABLE: 'true'
          SF_DISABLE_AUTOUPDATE: 'true'

      - name: Block commit and push if severity 3 violations are found
        run: |
          if [ -f scanner-report.csv ]; then
            severity_fail_count=$(awk -F',' '{gsub(/^ *| *$/, "", $2); if($2 == "\"3\"") count++} END {print count}' scanner-report.csv)
            echo "Severity 3 issues count: $severity_fail_count"
            if [ "$severity_fail_count" -gt 0 ]; then
              echo "Blocking push due to severity 3 vulnerabilities found."
              exit 1 # Exit with failure if violations are found
            else
              echo "No severity 3 vulnerabilities found. Proceeding."
            fi
          else
            echo "No scanner report found."
            exit 1 # Fail the job if no scanner report is found

      - name: Commit and Push changes (if scan passes)
        if: success()
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add . # Re-add the changes
          git commit -m "Auto commit after successful code scan"
          git push origin HEAD